import sys
import os

#HELP
#python Extract_all_ELF.py [src_file] [dst_dir]

src_file = sys.argv[1]
dst_dir = sys.argv[2]

if os.path.exists(dst_dir):
	pass
else:
	os.makedirs(dst_dir) 
#get the ELF offsets
cmd1 = "grep --byte-offset --only-matching --text 'ELF' {} ".format(src_file)
cmd2 = "| awk  -F ':' '{print $1}'"
cmd_offsets = cmd1 + cmd2
cmd_dd = "dd if={0} skip={1} of={2}  bs=1 count={3}"
offsets = os.popen(cmd_offsets).read()
off_lists = offsets.split('\n')[:-1]

#cal the lens
new_offsets = []
lens = []
for i in off_lists:
	new_offsets.append(int(i)-1)
for i in range(len(new_offsets)-1):
	lens.append(new_offsets[i+1]-new_offsets[i])

#for the most ELFs
for i in range(len(lens)):
	cmd = cmd_dd.format(src_file,new_offsets[i],dst_dir+'/'+str(new_offsets[i]),lens[i])
	os.system(cmd)

#the last ELF
os.system("dd if={0} skip={1} of={2}".format(src_file,new_offsets[-1],len(lens)))